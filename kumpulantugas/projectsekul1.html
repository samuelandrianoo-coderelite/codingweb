<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tritunggal Study Planner ‚Äî v4 (Complete)</title>

<!-- FullCalendar + Chart.js CDNs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

<style>
  :root{
    --accent:#2b9e73;
    --muted:#eef6f0;
    --danger:#c04e4e;
    --bg:#f1fcf6;
    --card:#fff;
    --text:#0b2f1a;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0e1724; --muted:#102022; --text:#e6f6ef; --accent:#46d19a;
  }
  body{font-family:Inter, Arial, sans-serif;margin:0;background:linear-gradient(180deg,var(--bg),#e6f7ef);display:flex;justify-content:center;padding:20px;color:var(--text)}
  .app{width:390px;background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.08);overflow:hidden}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eef6f0}
  header h1{font-size:16px;color:var(--accent);margin:0}
  .screen{display:none;padding:14px;height:700px;overflow:auto}
  .active{display:block}
  button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  .muted{background:#56b893}
  .danger{background:var(--danger)}
  .nav{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e0efe6;margin:6px 0;font-size:14px;background:transparent;color:var(--text)}
  ul{list-style:none;padding:0;margin:0}
  li.card{background:#f7fff7;padding:8px;border-radius:8px;margin:8px 0;box-shadow:0 4px 10px rgba(0,0,0,0.03)}
  .row{display:flex;gap:8px}
  .half{flex:1}
  .small{font-size:13px;color:#3b6b55}
  .tiny{font-size:12px;color:#666}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#eafaf2;color:#064a36;font-size:12px;margin:4px 2px;}
  .calendar-wrap{background:var(--card);padding:8px;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,0.05)}
  .controls{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  .file-preview{font-size:12px;color:#444;margin-top:6px}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--card);padding:12px;border-radius:10px;width:90%;max-width:520px;max-height:80vh;overflow:auto}
  .event-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
  footer{padding:10px;text-align:center;color:#666;font-size:12px}
  .summary{background:var(--muted);padding:8px;border-radius:8px;margin-top:8px}
  .tog{display:inline-flex;align-items:center;gap:8px}
  .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .link-input{display:flex;gap:8px}
  .small-muted{font-size:12px;color:#2f6b4e}
</style>
</head>
<body>
<div class="app" role="application" id="appRoot">
  <header>
    <h1>Tritunggal Study Planner</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="themeToggle" title="Toggle theme">üåì</button>
      <button id="notifBtn" title="Enable notifications">üîî</button>
    </div>
  </header>

  <!-- LOGIN -->
  <main id="login" class="screen active">
    <h2 class="small">Login</h2>
    <input id="loginUser" placeholder="Username" />
    <input id="loginPass" type="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
    <div class="row" style="margin-top:8px">
      <button id="openRegister" class="muted">Register</button>
      <button id="demoBtn" style="background:#4b9be0">Use Demo</button>
    </div>
    <p class="tiny">This app stores data locally in your browser. Cloud linking accepts share-links (Google Drive/Dropbox) ‚Äî follow instructions in Settings to connect.</p>
  </main>

  <!-- REGISTER -->
  <section id="register" class="screen">
    <h2 class="small">Register</h2>
    <input id="regUser" placeholder="Username" />
    <input id="regName" placeholder="Full name" />
    <input id="regPass1" type="password" placeholder="Password" />
    <input id="regPass2" type="password" placeholder="Confirm password" />
    <button id="registerBtn">Create Account</button>
    <button id="backToLogin" class="muted" style="margin-top:8px">Back</button>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="screen">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2 id="greeting" style="margin:0">Welcome</h2>
        <div id="motBanner" class="summary" style="margin-top:6px"></div>
      </div>
      <div>
        <button id="openCalendarQuick" title="Open Calendar">üóìÔ∏è</button>
      </div>
    </div>

    <div class="nav">
      <div class="card small" style="padding:8px;border-radius:8px;background:var(--card);box-shadow:0 6px 20px rgba(0,0,0,0.03)">
        <strong>Next up</strong>
        <div id="nextUp" class="tiny">No upcoming events</div>
      </div>

      <div class="card small" style="padding:8px;border-radius:8px;background:var(--card);box-shadow:0 6px 20px rgba(0,0,0,0.03)">
        <strong>Upcoming reminders</strong>
        <div id="reminderList" class="tiny">No reminders scheduled</div>
      </div>

      <div class="card small" style="padding:8px;border-radius:8px;background:var(--card);box-shadow:0 6px 20px rgba(0,0,0,0.03)">
        <strong>Quick Actions</strong>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="gotoSchedule" class="muted">Schedule</button>
          <button id="gotoAssignments" class="muted">Assignments</button>
          <button id="gotoTodo" class="muted">To-Do</button>
        </div>
      </div>

      <div class="card small">
        <strong>Today</strong>
        <div class="tiny" id="todaySummary">No tasks for today</div>
      </div>

      <div class="row">
        <button id="openCalendar" class="muted half">Open Calendar</button>
        <button id="openProgress" class="muted half">Progress</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="openSettings" class="muted half">Settings</button>
        <button id="profileBtn" class="muted half">Profile</button>
      </div>

      <button id="logout" class="danger">Logout</button>
    </div>
  </section>

  <!-- STUDY SCHEDULE (calendar with add) -->
  <section id="schedule" class="screen">
    <h2>Study Schedule</h2>
    <div class="calendar-wrap">
      <div class="controls">
        <input id="schedTitle" placeholder="Session title (e.g., Math - Chapter 2)" />
        <input id="schedSubject" placeholder="Subject (e.g., Math)" />
        <input id="schedColor" type="color" value="#83d7af" />
        <div class="row">
          <input id="schedStart" type="datetime-local" class="half"/>
          <input id="schedEnd" type="datetime-local" class="half"/>
        </div>
        <input id="schedReminderMins" type="number" placeholder="Reminder minutes before (0 off)" />
        <button id="addSchedBtn">Add Session</button>
        <button id="syncToCal" class="muted">Sync to Calendar</button>
        <button id="exportICS" class="muted">Export .ics</button>
      </div>

      <div id="fcCalendar" style="margin-top:8px"></div>
    </div>
    <button class="nav-btn" onclick="showScreen('dashboard')">Back</button>
  </section>

  <!-- CALENDAR (Google-like) -->
  <section id="calendar" class="screen">
    <h2>Calendar</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <button id="viewWeek">Week</button>
      <button id="viewMonth">Month</button>
      <button id="addQuickNow" class="muted">Quick +1h</button>
      <div style="flex:1"></div>
      <button id="exportBtn" class="muted">Export</button>
      <label class="muted" style="padding:6px;border-radius:8px;cursor:pointer">
        Import <input id="importFile" type="file" style="display:none" />
      </label>
    </div>

    <div class="calendar-wrap">
      <div id="mainCalendar"></div>
    </div>

    <button class="nav-btn" onclick="showScreen('dashboard')">Back</button>
  </section>

  <!-- ASSIGNMENTS -->
  <section id="assignments" class="screen">
    <h2>Assignments</h2>
    <input id="asTitle" placeholder="Title" />
    <div class="row">
      <input id="asDue" type="date" class="half" />
      <select id="asPriority" class="half">
        <option>Low</option><option selected>Medium</option><option>High</option>
      </select>
    </div>
    <input id="asSubject" placeholder="Subject" />
    <select id="asStatus"><option>Not Started</option><option>In Progress</option><option>Completed</option></select>
    <input id="asLink" placeholder="Link (Google Drive / Dropbox / URL)" />
    <input id="asFile" type="file" />
    <button id="addAssignBtn">Add Assignment</button>

    <h3 style="margin-top:12px">Your assignments</h3>
    <ul id="assignList"></ul>

    <button class="nav-btn" onclick="showScreen('dashboard')">Back</button>
  </section>

  <!-- TODO -->
  <section id="todo" class="screen">
    <h2>To-Do</h2>
    <div class="row">
      <input id="todoText" placeholder="Task description" class="half" />
      <input id="todoDate" type="date" class="half" />
    </div>
    <button id="addTodoBtn">Add Task</button>
    <h3 style="margin-top:12px">Tasks</h3>
    <ul id="todoList"></ul>
    <button class="nav-btn" onclick="showScreen('dashboard')">Back</button>
  </section>

  <!-- RESOURCES -->
  <section id="resources" class="screen">
    <h2>Study Resources</h2>
    <input id="resTitle" placeholder="Title" />
    <input id="resSubject" placeholder="Subject (category)" />
    <div class="link-input">
      <input id="resLink" placeholder="Link (or leave to upload)" />
      <button id="pasteShare" class="muted" title="Paste share link">Paste</button>
    </div>
    <input id="resFile" type="file" />
    <button id="addResBtn">Save Resource</button>
    <h3 style="margin-top:12px">Resources</h3>
    <ul id="resList"></ul>
    <button class="nav-btn" onclick="showScreen('dashboard')">Back</button>
  </section>

  <!-- PROGRESS -->
  <section id="progress" class="screen">
    <h2>Progress Tracker</h2>
    <canvas id="progressChart" width="320" height="180"></canvas>
    <div id="weeklySummary" class="summary"></div>
    <button class="nav-btn" onclick="showScreen('dashboard')">Back</button>
  </section>

  <!-- MOTIVATION SETTINGS -->
  <section id="motivationSettings" class="screen">
    <h2>Motivation Settings</h2>
    <label class="tog"><input id="motToggle" type="checkbox" /> Show daily motivation banner</label>
    <input id="newQuote" placeholder="Add custom quote (no emoji needed)" />
    <button id="addQuoteBtn">Add Quote</button>
    <h4 style="margin-top:12px">Saved custom quotes</h4>
    <ul id="customQuotes"></ul>
    <button class="nav-btn" onclick="showScreen('dashboard')">Back</button>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="screen">
    <h2>Settings</h2>
    <div class="settings-grid">
      <div>
        <h4>Notifications</h4>
        <label><input id="notifSessions" type="checkbox" /> Session reminders</label><br>
        <label><input id="notifAssignments" type="checkbox" /> Assignment reminders</label><br>
        <label><input id="notifInApp" type="checkbox" /> In-app alerts (fallback)</label>
      </div>
      <div>
        <h4>Cloud Links</h4>
        <div class="small-muted">Paste share-links (Google Drive / Dropbox) to attach files quickly.</div>
        <input id="cloudLink" placeholder="Paste share link here" />
        <button id="saveCloudLink" class="muted">Save Link</button>
        <div id="cloudLinksList" class="tiny" style="margin-top:8px"></div>
      </div>
    </div>

    <h4 style="margin-top:12px">Other</h4>
    <button id="clearLocal" class="danger">Clear local data (for current user)</button>
    <div style="margin-top:8px"><small class="tiny">Note: Direct Google Drive/Dropbox API integration requires server-side OAuth. This UI accepts share-links and uploads for convenience.</small></div>
    <button class="nav-btn" onclick="showScreen('dashboard')">Back</button>
  </section>

  <!-- PROFILE -->
  <section id="profile" class="screen">
    <h2>Profile</h2>
    <input id="profileName" placeholder="Full name" />
    <input id="profilePass" type="password" placeholder="New password (leave blank to keep)" />
    <button id="saveProfile" class="muted">Save Profile</button>
    <button class="nav-btn" onclick="showScreen('dashboard')">Back</button>
  </section>

  <footer style="padding:10px;text-align:center;color:#666;font-size:12px">Data stored locally. Use Export/Import to back up. v4</footer>
</div>

<!-- modal for day details -->
<div id="modal" class="modal-backdrop">
  <div class="modal" id="modalContent"></div>
</div>

<script>
/* ---------------------------
   Utilities & storage helpers
   --------------------------- */
const LS = { users: 'tp_users_v4' };
function userKey(username, key) { return `${username}_${key}_v4`; }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function load(key, def=[]){ try{ const v = JSON.parse(localStorage.getItem(key)); return v===null?def:v; }catch(e){return def} }

/* ---------------------------
   Auth: register / login / demo
   --------------------------- */
let currentUser = null;
document.getElementById('openRegister').onclick = ()=>showScreen('register');
document.getElementById('backToLogin').onclick = ()=>showScreen('login');
document.getElementById('registerBtn').onclick = registerUser;
document.getElementById('loginBtn').onclick = loginUser;
document.getElementById('demoBtn').onclick = createDemoAndLogin;

function registerUser(){
  const u = document.getElementById('regUser').value.trim();
  const name = document.getElementById('regName').value.trim();
  const p1 = document.getElementById('regPass1').value;
  const p2 = document.getElementById('regPass2').value;
  if(!u||!name||!p1||!p2) return alert('Fill all fields');
  if(p1!==p2) return alert('Passwords mismatch');
  let users = load(LS.users,[]);
  if(users.find(x=>x.username===u)) return alert('Username exists');
  users.push({username:u,name,pass:p1,motivationOn:true});
  save(LS.users, users);
  alert('Registered. Login now.');
  showScreen('login');
}

function loginUser(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  let users = load(LS.users,[]);
  const found = users.find(x=>x.username===u && x.pass===p);
  if(!found) return alert('Invalid credentials (or register first)');
  currentUser = found;
  afterLogin();
}

function createDemoAndLogin(){
  const u = 'demo'; const name = 'Demo User';
  let users = load(LS.users,[]);
  if(!users.find(x=>x.username===u)){
    users.push({username:u,name,pass:'demo',motivationOn:true});
    save(LS.users, users);
  }
  currentUser = users.find(x=>x.username===u);
  save(userKey(u,'assign'), [
    {title:'Math Homework', due: nextDay(1), subject:'Math', priority:'High', status:'Not Started', link:'', fileName:'', notified:false},
    {title:'Physics Lab Report', due: nextDay(2), subject:'Physics', priority:'Medium', status:'In Progress', link:'', fileName:'', notified:false},
    {title:'History Essay', due: nextDay(5), subject:'History', priority:'Low', status:'Not Started', link:'', fileName:'', notified:false}
  ]);
  save(userKey(u,'schedule'), [
    {title:'Math ‚Äî Calculus', subject:'Math', color:'#4f46e5', start: nextHourISO(2), end: nextHourISO(3), reminderMins:30},
    {title:'Physics ‚Äî Revision', subject:'Physics', color:'#059669', start: nextHourISO(5), end: nextHourISO(6), reminderMins:60}
  ]);
  save(userKey(u,'todos'), [
    {text:'Review formula sheet', date: todayISO(), done:false},
    {text:'Read chapter 3', date: nextDay(0), done:false}
  ]);
  save(userKey(u,'res'), [
    {title:'Khan Academy ‚Äî Calculus', subject:'Math', link:'https://www.khanacademy.org', fileName:'', fileData:''}
  ]);
  afterLogin();
}

/* helper date funcs */
function todayISO(){ const d = new Date(); return d.toISOString().slice(0,10); }
function nextDay(n){ const d=new Date(); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
function nextHourISO(offset){ const d=new Date(); d.setHours(d.getHours()+offset); return d.toISOString().slice(0,16); }

/* ---------------------------
   After login: load UI & data
   --------------------------- */
function afterLogin(){
  document.getElementById('greeting').textContent = `Welcome, ${currentUser.name}`;
  showScreen('dashboard');
  ensureDefaults();
  renderMotivationBanner();
  renderNextUp(); renderTodaySummary(); renderAssignList(); renderTodos(); renderResources();
  initFullCalendarMain(); initFullCalendarSchedule(); updateProgress(); scheduleAllReminders(); renderRemindersCard(); renderCloudLinks(); renderCustomQuotes(); loadNotificationSettings();
}

/* ensure keys exist */
function ensureDefaults(){
  ['assign','schedule','todos','res','quotes','motivationOn','cloudLinks','notifSettings'].forEach(k=>{
    const key = userKey(currentUser.username,k);
    if(localStorage.getItem(key)===null){
      if(k==='assign') save(key,[]);
      else if(k==='schedule') save(key,[]);
      else if(k==='todos') save(key,[]);
      else if(k==='res') save(key,[]);
      else if(k==='quotes') save(key,[]);
      else if(k==='cloudLinks') save(key,[]);
      else if(k==='notifSettings') save(key,{sessions:true,assignments:true,inApp:true});
      else if(k==='motivationOn') localStorage.setItem(key, JSON.stringify(true));
    }
  });
}

/* ---------------------------
   Navigation helper
   --------------------------- */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  if(id==='assignments') renderAssignList();
  if(id==='todo') renderTodos();
  if(id==='resources') renderResources();
  if(id==='dashboard') { renderNextUp(); renderTodaySummary(); renderMotivationBanner(); renderRemindersCard(); }
}

/* ---------------------------
   Theme toggle
   --------------------------- */
const themeToggle = document.getElementById('themeToggle');
let dark = false;
themeToggle.onclick = ()=>{ dark = !dark; document.documentElement.setAttribute('data-theme', dark? 'dark':''); };

/* ---------------------------
   Motivation banner & settings
   --------------------------- */
const defaultQuotes = [
  "‚ú® Keep going, you're doing great today!",
  "üí™ Small steps every day lead to big results.",
  "üåü Believe in your ability to improve.",
  "üìö Success starts with self-discipline.",
  "üí≠ Focus on progress, not perfection."
];
function renderMotivationBanner(){
  if(!currentUser) return;
  const key = userKey(currentUser.username,'motivationOn');
  const on = JSON.parse(localStorage.getItem(key) || 'true');
  document.getElementById('motToggle').checked = on;
  const banner = document.getElementById('motBanner');
  if(!on){ banner.style.display='none'; return; }
  const pool = [...defaultQuotes, ...(load(userKey(currentUser.username,'quotes'),[]))];
  const pick = pool[Math.floor(Math.random()*pool.length)];
  banner.innerHTML = `<strong>‚ú® ${pick}</strong>`;
  banner.style.display='block';
}

document.getElementById('addQuoteBtn').onclick = ()=>{
  const q = document.getElementById('newQuote').value.trim();
  if(!currentUser) return alert('Login first');
  if(!q) return alert('Type a quote');
  const key = userKey(currentUser.username,'quotes');
  const arr = load(key,[]);
  arr.push(q);
  save(key,arr);
  document.getElementById('newQuote').value=''; renderCustomQuotes(); alert('Quote added');
};
function renderCustomQuotes(){ if(!currentUser) return; const key=userKey(currentUser.username,'quotes'); const arr=load(key,[]); const ul=document.getElementById('customQuotes'); ul.innerHTML=''; arr.forEach((q,i)=>{ const li=document.createElement('li'); li.className='tiny'; li.innerHTML = `${q} <button onclick="removeQuote(${i})" style="background:#f2dede;border:none;padding:4px;border-radius:6px;color:#a00;margin-left:8px">Remove</button>`; ul.appendChild(li); }); }
function removeQuote(i){ const key=userKey(currentUser.username,'quotes'); const arr=load(key,[]); arr.splice(i,1); save(key,arr); renderCustomQuotes(); }
document.getElementById('motToggle').addEventListener('change', ()=>{ if(!currentUser) return; const key=userKey(currentUser.username,'motivationOn'); localStorage.setItem(key, JSON.stringify(document.getElementById('motToggle').checked)); renderMotivationBanner(); });

/* ---------------------------
   Assignments manager
   --------------------------- */
document.getElementById('addAssignBtn').onclick = addAssignment;
function addAssignment(){
  if(!currentUser) return alert('Login');
  const title = document.getElementById('asTitle').value.trim();
  const due = document.getElementById('asDue').value;
  const subject = document.getElementById('asSubject').value.trim();
  const priority = document.getElementById('asPriority').value;
  const status = document.getElementById('asStatus').value;
  const link = document.getElementById('asLink').value.trim();
  const fileInput = document.getElementById('asFile');
  if(!title||!due||!subject) return alert('Fill title, due date, subject');
  const obj = {title,due,subject,priority,status,link,fileName:'',fileData:'',notified:false};
  if(fileInput.files && fileInput.files[0]){
    const f=fileInput.files[0]; obj.fileName = f.name; const reader = new FileReader(); reader.onload = function(e){ obj.fileData = e.target.result; pushAssign(obj); }; reader.readAsDataURL(f);
  } else { pushAssign(obj); }
  document.getElementById('asTitle').value=''; document.getElementById('asDue').value=''; document.getElementById('asSubject').value=''; document.getElementById('asLink').value=''; document.getElementById('asFile').value='';
}
function pushAssign(obj){ const key = userKey(currentUser.username,'assign'); const arr = load(key,[]); arr.push(obj); save(key,arr); renderAssignList(); addAssignsToCalendar(); scheduleAssignmentReminders(); alert('Saved assignment'); }
function renderAssignList(){ if(!currentUser) return; const key=userKey(currentUser.username,'assign'); const arr=load(key,[]); const ul=document.getElementById('assignList'); ul.innerHTML=''; arr.forEach((a,i)=>{ const li=document.createElement('li'); li.className='card'; li.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${a.title}</strong><div class="tiny">${a.subject} ‚Ä¢ Due ${a.due} ‚Ä¢ ${a.priority}</div></div><div style="text-align:right"><div class="tiny">Status: <em>${a.status}</em></div><div style="margin-top:8px"><button onclick="markAssign(${i})" class="muted">Mark Done</button> <button onclick="deleteAssign(${i})" class="danger">Delete</button></div></div></div>`; ul.appendChild(li); }); }
function markAssign(i){ const key=userKey(currentUser.username,'assign'); const arr=load(key,[]); if(arr[i]) { arr[i].status='Completed'; save(key,arr); renderAssignList(); addAssignsToCalendar(); updateProgress(); } }
function deleteAssign(i){ const key=userKey(currentUser.username,'assign'); const arr=load(key,[]); if(arr[i]) arr.splice(i,1); save(key,arr); renderAssignList(); addAssignsToCalendar(); updateProgress(); }

/* ---------------------------
   To-Do list
   --------------------------- */
document.getElementById('addTodoBtn').onclick = ()=>{ if(!currentUser) return alert('Login'); const text=document.getElementById('todoText').value.trim(); const date=document.getElementById('todoDate').value || todayISO(); if(!text) return alert('Enter task'); const obj={text,date,done:false}; const key=userKey(currentUser.username,'todos'); const arr=load(key,[]); arr.push(obj); save(key,arr); document.getElementById('todoText').value=''; renderTodos(); updateProgress(); };
function renderTodos(){ if(!currentUser) return; const key=userKey(currentUser.username,'todos'); const arr=load(key,[]); const ul=document.getElementById('todoList'); ul.innerHTML=''; arr.forEach((t,i)=>{ const li=document.createElement('li'); li.className='card'; li.innerHTML = `<label><input type="checkbox" ${t.done?'checked':''} onchange="toggleTodo(${i})"/> ${t.text} <div class="tiny">Due: ${t.date}</div></label><div style="text-align:right"><button onclick="delTodo(${i})" class="danger">Delete</button></div>`; ul.appendChild(li); }); }
function toggleTodo(i){ const key=userKey(currentUser.username,'todos'); const arr=load(key,[]); arr[i].done=!arr[i].done; save(key,arr); renderTodos(); updateProgress(); }
function delTodo(i){ const key=userKey(currentUser.username,'todos'); const arr=load(key,[]); arr.splice(i,1); save(key,arr); renderTodos(); updateProgress(); }

/* ---------------------------
   Resources
   --------------------------- */
document.getElementById('addResBtn').onclick = ()=>{ if(!currentUser) return alert('Login'); const title=document.getElementById('resTitle').value.trim(); const subject=document.getElementById('resSubject').value.trim(); const link=document.getElementById('resLink').value.trim(); const fileInput=document.getElementById('resFile'); if(!title) return alert('Title required'); const obj={title,subject,link,fileName:'',fileData:''}; if(fileInput.files && fileInput.files[0]){ const f=fileInput.files[0]; obj.fileName=f.name; const reader=new FileReader(); reader.onload=(e)=>{ obj.fileData=e.target.result; pushRes(obj); }; reader.readAsDataURL(f); } else pushRes(obj); document.getElementById('resTitle').value=''; document.getElementById('resSubject').value=''; document.getElementById('resLink').value=''; document.getElementById('resFile').value=''; };
function pushRes(obj){ const key=userKey(currentUser.username,'res'); const arr=load(key,[]); arr.push(obj); save(key,arr); renderResources(); alert('Saved resource'); }
function renderResources(){ if(!currentUser) return; const arr=load(userKey(currentUser.username,'res'),[]); const ul=document.getElementById('resList'); ul.innerHTML=''; arr.forEach((r,i)=>{ const li=document.createElement('li'); li.className='card'; li.innerHTML=`<strong>${r.title}</strong><div class="tiny">${r.subject||''}</div>${r.link?`<div class='file-preview'><a href='${r.link}' target='_blank'>Open link</a></div>`:''}${r.fileName?`<div class='file-preview'>File: ${r.fileName}</div>`:''}<div style="margin-top:6px"><button onclick="deleteRes(${i})" class="danger">Delete</button></div>`; ul.appendChild(li); }); }
function deleteRes(i){ const key=userKey(currentUser.username,'res'); const arr=load(key,[]); if(arr[i]) arr.splice(i,1); save(key,arr); renderResources(); }

/* ---------------------------
   Progress tracker (Chart.js)
   --------------------------- */
let progressChart = null;
function updateProgress(){ if(!currentUser) return; const sched=load(userKey(currentUser.username,'schedule'),[]); const assigns=load(userKey(currentUser.username,'assign'),[]); const todos=load(userKey(currentUser.username,'todos'),[]); const days=[]; const data=[]; const now=new Date(); for(let i=6;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth(), now.getDate()-i); days.push(d.toLocaleDateString()); let hours=0; sched.forEach(s=>{ try{ const sstart=new Date(s.start); const send=new Date(s.end || s.start); if(sstart.toDateString()===d.toDateString()){ hours += (send - sstart)/3600000; } }catch(e){} }); data.push(Math.round(hours*100)/100); } const ctx=document.getElementById('progressChart'); if(progressChart) progressChart.destroy(); progressChart=new Chart(ctx,{ type:'bar', data:{labels:days,datasets:[{label:'Study hours',data,backgroundColor: days.map(()=> '#83d7af')}]}, options:{scales:{y:{beginAtZero:true}}} }); const totalHours=data.reduce((a,b)=>a+b,0); const completed=assigns.filter(a=>a.status==='Completed').length; const totalAssign=Math.max(1,assigns.length); const todoDone=todos.filter(t=>t.done).length; const totalTodos=Math.max(1,todos.length); document.getElementById('weeklySummary').textContent = `Last 7 days: ${totalHours} hours ‚Ä¢ Assignments: ${completed}/${totalAssign} ‚Ä¢ Todos done: ${todoDone}/${totalTodos}`; }

/* ---------------------------
   FullCalendar: main calendar & schedule calendar
   --------------------------- */
let mainCal=null; let schedCal=null;
function initFullCalendarMain(){ const el=document.getElementById('mainCalendar'); if(!el) return; if(mainCal){ mainCal.destroy(); mainCal=null; } mainCal=new FullCalendar.Calendar(el,{ initialView:'dayGridMonth', headerToolbar:{left:'prev,next today',center:'title',right:''}, height:500, editable:true, selectable:true, eventDisplay:'block', dateClick(info){ openDayModal(info.dateStr); }, eventClick(info){ openEventModal(info.event); }, eventDrop(info){ persistScheduleFromCalendarEvent(info.event); scheduleAllReminders(); updateProgress(); renderRemindersCard(); }, eventResize(info){ persistScheduleFromCalendarEvent(info.event); scheduleAllReminders(); updateProgress(); renderRemindersCard(); } }); mainCal.render(); addAssignsToCalendar(); addSchedulesToMainCalendar(); addTodosToCalendar(); }
function initFullCalendarSchedule(){ const el=document.getElementById('fcCalendar'); if(!el) return; if(schedCal){ schedCal.destroy(); schedCal=null; } schedCal=new FullCalendar.Calendar(el,{ initialView:'timeGridWeek', headerToolbar:{left:'prev,next today',center:'title',right:'timeGridWeek,timeGridDay,dayGridMonth'}, height:420, editable:true, selectable:true, select(info){ const title=prompt('Session title','Study Session'); if(!title){ schedCal.unselect(); return; } const subj=prompt('Subject (optional)',''); const color=prompt('Color hex (optional)',''); const rem=prompt('Reminder minutes before start (0 off)','30'); const ev={ title: title+(subj?` ‚Äî ${subj}`:''), start: info.startStr, end: info.endStr, backgroundColor: color||undefined, extendedProps:{subject:subj,reminderMins:parseInt(rem)||0} }; schedCal.addEvent(ev); persistScheduleEvents(); schedCal.unselect(); scheduleAllReminders(); updateProgress(); renderRemindersCard(); }, eventDrop(info){ persistScheduleEvents(); scheduleAllReminders(); updateProgress(); renderRemindersCard(); }, eventResize(info){ persistScheduleEvents(); scheduleAllReminders(); updateProgress(); renderRemindersCard(); }, eventClick(info){ const opt=prompt('Type "edit" to rename or "delete" to remove','edit'); if(opt==='delete'){ info.event.remove(); persistScheduleEvents(); updateProgress(); renderRemindersCard(); return; } if(opt==='edit'){ const t=prompt('New title', info.event.title); if(t) info.event.setProp('title',t); persistScheduleEvents(); updateProgress(); renderRemindersCard(); } } }); schedCal.render(); addSchedulesToSchedCalendar(); }
function addAssignsToCalendar(){ if(!mainCal) return; mainCal.getEvents().forEach(ev=>{ if(ev.id && ev.id.startsWith('assign_')) ev.remove(); }); const arr=load(userKey(currentUser.username,'assign'),[]); arr.forEach((a,i)=>{ const color=subjectColor(a.subject,a.status); mainCal.addEvent({ id:`assign_${i}`, title:a.title, start:a.due, allDay:true, backgroundColor:color, borderColor:color, extendedProps:{type:'assignment', subject:a.subject, priority:a.priority, status:a.status, raw:a}}); }); }
function addSchedulesToMainCalendar(){ if(!mainCal) return; mainCal.getEvents().forEach(ev=>{ if(ev.id && ev.id.startsWith('sched_')) ev.remove(); }); const arr=load(userKey(currentUser.username,'schedule'),[]); arr.forEach((s,i)=>{ const color=s.color || subjectColor(s.subject); mainCal.addEvent({ id:`sched_${i}`, title:s.title, start:s.start, end:s.end, backgroundColor:color, borderColor:color, extendedProps:{type:'schedule',subject:s.subject,reminderMins:s.reminderMins || 0, raw:s }}); }); }
function addSchedulesToSchedCalendar(){ if(!schedCal) return; schedCal.getEvents().forEach(ev=>{ if(ev.id && ev.id.startsWith('sched_')) ev.remove(); }); const arr=load(userKey(currentUser.username,'schedule'),[]); arr.forEach((s,i)=>{ const color=s.color || subjectColor(s.subject); schedCal.addEvent({ id:`sched_${i}`, title:s.title, start:s.start, end:s.end, backgroundColor:color, borderColor:color, extendedProps:{type:'schedule',subject:s.subject,reminderMins:s.reminderMins || 0, raw:s }}); }); }
function addTodosToCalendar(){ if(!mainCal) return; mainCal.getEvents().forEach(ev=>{ if(ev.id && ev.id.startsWith('todo_')) ev.remove(); }); const arr=load(userKey(currentUser.username,'todos'),[]); arr.forEach((t,i)=>{ const color=t.done? '#7ccf9e' : '#f9c74f'; mainCal.addEvent({ id:`todo_${i}`, title:t.text, start:t.date, allDay:true, backgroundColor:color, borderColor:color, extendedProps:{type:'todo', raw:t}}); }); }
function persistScheduleEvents(){ if(!schedCal) return; const evs=schedCal.getEvents().map((e,i)=>{ return {title:e.title, subject:e.extendedProps.subject || '', color: e.backgroundColor || '', start: e.startStr, end: e.endStr, reminderMins: e.extendedProps.reminderMins || 0}; }); save(userKey(currentUser.username,'schedule'), evs); addSchedulesToMainCalendar(); }
function persistScheduleFromCalendarEvent(event){ const key=userKey(currentUser.username,'schedule'); const arr=load(key,[]); if(!event.id) return; if(event.id.startsWith('sched_')){ const idx=parseInt(event.id.split('_')[1]); if(!isNaN(idx) && arr[idx]){ arr[idx].title=event.title; arr[idx].start=event.startStr; arr[idx].end=event.endStr; save(key,arr); } else { arr.push({title:event.title,subject:event.extendedProps.subject||'',color:event.backgroundColor,start:event.startStr,end:event.endStr,reminderMins:event.extendedProps.reminderMins||0}); save(key,arr); } } addSchedulesToMainCalendar(); }

/* ---------------------------
   Subject color mapping
   --------------------------- */
function subjectColor(subject,status){ if(!subject) return '#83d7af'; const s=subject.toLowerCase(); if(s.includes('math')) return '#4f46e5'; if(s.includes('physics')||s.includes('science')) return '#059669'; if(s.includes('english')||s.includes('bahasa')) return '#f59e0b'; if(s.includes('history')||s.includes('civics')) return '#ef4444'; if(status && status.toLowerCase().includes('completed')) return '#7ccf9e'; if(status && status.toLowerCase().includes('in progress')) return '#f6d365'; return '#83d7af'; }

/* ---------------------------
   Modal helpers
   --------------------------- */
function openDayModal(dateStr){ const modal=document.getElementById('modal'); const body=document.getElementById('modalContent'); body.innerHTML = `<h3>Events on ${new Date(dateStr).toDateString()}</h3>`; const evs=(mainCal? mainCal.getEvents():[]).filter(ev=> ev.start && ev.start.toISOString().slice(0,10)===dateStr); if(evs.length===0){ body.innerHTML += '<div class="tiny">No events</div>'; } evs.forEach(ev=>{ const div=document.createElement('div'); div.className='card'; const raw=ev.extendedProps.raw||{}; div.innerHTML = `<div><strong>${ev.title}</strong><div class="tiny">${ev.extendedProps.subject||''} ${ev.extendedProps.priority? ' ‚Ä¢ '+ev.extendedProps.priority : ''}</div></div><div style="margin-top:6px" class="tiny">${raw.link? `<a href="${raw.link}" target="_blank">Open link</a>`:''}${raw.fileName?'<div class="file-preview">File: '+raw.fileName+'</div>':''}</div>`; body.appendChild(div); }); modal.style.display='flex'; }
function openEventModal(event){ const modal=document.getElementById('modal'); const body=document.getElementById('modalContent'); body.innerHTML=`<h3>${event.title}</h3>`; const raw=event.extendedProps.raw||{}; body.innerHTML += `<div class="tiny">Type: ${event.extendedProps.type||'Event'} ‚Ä¢ Subject: ${event.extendedProps.subject||'‚Äî'}</div>`; if(raw.link) body.innerHTML += `<div style="margin-top:8px"><a href="${raw.link}" target="_blank">Open link</a></div>`; if(raw.fileName) body.innerHTML += `<div class="file-preview">File: ${raw.fileName}</div>`; modal.style.display='flex'; }
document.getElementById('modal').addEventListener('click',(e)=>{ if(e.target===document.getElementById('modal')) document.getElementById('modal').style.display='none'; });

/* ---------------------------
   Next up and today summary
   --------------------------- */
function renderNextUp(){ if(!currentUser) return; const sched=load(userKey(currentUser.username,'schedule'),[]); const assigns=load(userKey(currentUser.username,'assign'),[]); const todos=load(userKey(currentUser.username,'todos'),[]); const now=new Date(); let nextSched=null; sched.forEach(s=>{ try{ const d=new Date(s.start); if(d>now && (!nextSched || d<new Date(nextSched.start))) nextSched=s; }catch(e){} }); let nextAssign=null; assigns.forEach(a=>{ try{ const d=new Date(a.due+'T09:00:00'); if(d>now && (!nextAssign || d<new Date(nextAssign.due+'T09:00:00'))) nextAssign=a; }catch(e){} }); const el=document.getElementById('nextUp'); el.innerHTML=''; if(nextSched) el.innerHTML += `<div><strong>Next session</strong><div class="tiny">${nextSched.title} ‚Ä¢ ${new Date(nextSched.start).toLocaleString()}</div></div>`; if(nextAssign) el.innerHTML += `<div style="margin-top:6px"><strong>Next due</strong><div class="tiny">${nextAssign.title} ‚Ä¢ ${nextAssign.due}</div></div>`; if(!nextSched && !nextAssign) el.textContent='No upcoming events'; }
function renderTodaySummary(){ if(!currentUser) return; const todays=todayISO(); const todos=load(userKey(currentUser.username,'todos'),[]).filter(t=>t.date===todays); const done=todos.filter(t=>t.done).length; const el=document.getElementById('todaySummary'); if(todos.length===0) el.textContent='No tasks for today'; else el.textContent=`${done}/${todos.length} tasks completed today`; }

/* ---------------------------
   Add schedule from form
   --------------------------- */
document.getElementById('addSchedBtn').onclick = ()=>{ if(!currentUser) return alert('Login'); const title=document.getElementById('schedTitle').value.trim(); const subject=document.getElementById('schedSubject').value.trim(); const color=document.getElementById('schedColor').value; const start=document.getElementById('schedStart').value; const end=document.getElementById('schedEnd').value; const rem=parseInt(document.getElementById('schedReminderMins').value) || 0; if(!title||!subject||!start||!end) return alert('Fill title, subject, start, end'); const obj={title,subject,color,start,end,reminderMins:rem}; const key=userKey(currentUser.username,'schedule'); const arr=load(key,[]); arr.push(obj); save(key,arr); addSchedulesToSchedCalendar(); addSchedulesToMainCalendar(); document.getElementById('schedTitle').value=''; updateProgress(); scheduleAllReminders(); renderRemindersCard(); alert('Session added'); };
document.getElementById('syncToCal').onclick = ()=>{ addSchedulesToMainCalendar(); alert('Synced study schedule to calendar view'); };

/* ---------------------------
   Export / Import
   --------------------------- */
document.getElementById('exportBtn').onclick = ()=>{ if(!currentUser) return alert('Login'); const data={ assigns: load(userKey(currentUser.username,'assign'),[]), schedule: load(userKey(currentUser.username,'schedule'),[]), todos: load(userKey(currentUser.username,'todos'),[]), res: load(userKey(currentUser.username,'res'),[]), quotes: load(userKey(currentUser.username,'quotes'),[]) }; const blob=new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`tritunggal_export_${currentUser.username}.json`; a.click(); };
document.getElementById('importFile').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f || !currentUser) return; const r=new FileReader(); r.onload=(ev)=>{ try{ const obj=JSON.parse(ev.target.result); if(obj.assigns) save(userKey(currentUser.username,'assign'), obj.assigns); if(obj.schedule) save(userKey(currentUser.username,'schedule'), obj.schedule); if(obj.todos) save(userKey(currentUser.username,'todos'), obj.todos); if(obj.res) save(userKey(currentUser.username,'res'), obj.res); if(obj.quotes) save(userKey(currentUser.username,'quotes'), obj.quotes); alert('Imported data for user.'); afterLogin(); }catch(err){ alert('Invalid file'); } }; r.readAsText(f); });

/* ---------------------------
   Notifications & reminders
   --------------------------- */
let notificationAllowed=false; document.getElementById('notifBtn').onclick = async ()=>{ if(!("Notification" in window)) return alert('Notifications not supported'); const p=await Notification.requestPermission(); notificationAllowed=(p==='granted'); alert('Notification permission: '+p); };

function loadNotificationSettings(){ const s=load(userKey(currentUser.username,'notifSettings'),{sessions:true,assignments:true,inApp:true}); document.getElementById('notifSessions').checked=s.sessions; document.getElementById('notifAssignments').checked=s.assignments; document.getElementById('notifInApp').checked=s.inApp; }
["notifSessions","notifAssignments","notifInApp"].forEach(id=>{ document.getElementById(id).addEventListener('change', ()=>{ const s={sessions:document.getElementById('notifSessions').checked, assignments:document.getElementById('notifAssignments').checked, inApp:document.getElementById('notifInApp').checked}; save(userKey(currentUser.username,'notifSettings'), s); }); });

function scheduleAllReminders(){ if(!currentUser) return; const settings=load(userKey(currentUser.username,'notifSettings'),{sessions:true,assignments:true,inApp:true}); const schedules=load(userKey(currentUser.username,'schedule'),[]); if(settings.sessions){ schedules.forEach((s,i)=>{ if(!s.reminderMins) return; try{ const start=new Date(s.start); const when=start.getTime() - s.reminderMins*60000; const delay=when - Date.now(); if(delay>0 && delay < 1000*60*60*24*7){ setTimeout(()=>sendNotification(`Upcoming session: ${s.title}`, `Subject: ${s.subject} starts at ${new Date(s.start).toLocaleString()}`), delay); } }catch(e){} }); }
  scheduleAssignmentReminders(); }

function scheduleAssignmentReminders(){ if(!currentUser) return; const settings=load(userKey(currentUser.username,'notifSettings'),{sessions:true,assignments:true,inApp:true}); if(!settings.assignments) return; const assigns=load(userKey(currentUser.username,'assign'),[]); assigns.forEach((a,i)=>{ try{ const dueDate=new Date(a.due+'T09:00:00'); const when=dueDate.getTime() - 24*60*60*1000; const delay=when - Date.now(); if(delay>0 && delay<1000*60*60*24*7){ setTimeout(()=> sendNotification(`Assignment due tomorrow: ${a.title}`, `Due: ${a.due}`), delay); }else if(delay<=0 && !a.notified){ sendNotification(`Assignment due soon: ${a.title}`, `Due: ${a.due}`); a.notified=true; const arr=load(userKey(currentUser.username,'assign'),[]); arr[i]=a; save(userKey(currentUser.username,'assign'),arr); } }catch(e){} }); }

function sendNotification(title,body){ const settings=load(userKey(currentUser.username,'notifSettings'),{sessions:true,assignments:true,inApp:true}); if(notificationAllowed && Notification.permission==='granted'){ new Notification(title,{ body }); } else { if(settings.inApp) { console.log('NOTIF:',title,body); // simple in-app toast fallback
    toast(`${title}\n${body}`);
  } }
}

/* simple toast */
function toast(msg){ alert(msg); }

/* ---------------------------
   Reminder list (dashboard)
   --------------------------- */
function getUpcomingReminders(){ const reminders=[]; const schedules=load(userKey(currentUser.username,'schedule'),[]); const assigns=load(userKey(currentUser.username,'assign'),[]); const now=Date.now(); schedules.forEach(s=>{ try{ if(!s.reminderMins) return; const start=new Date(s.start).getTime(); const when=start - s.reminderMins*60000; if(when>now-1000*60*60*24*0 && when<now+1000*60*60*24*14) reminders.push({type:'session',title:s.title,when,display: new Date(when).toLocaleString()}); }catch(e){} }); assigns.forEach(a=>{ try{ const due=new Date(a.due+'T09:00:00').getTime(); const when=due - 24*60*60*1000; if(when>now-1000*60*60*24*0 && when<now+1000*60*60*24*14) reminders.push({type:'assignment',title:a.title,when,display:new Date(when).toLocaleString()}); }catch(e){} }); reminders.sort((a,b)=>a.when-b.when); return reminders; }
function renderRemindersCard(){ const list=getUpcomingReminders(); const el=document.getElementById('reminderList'); if(!list.length) { el.textContent='No reminders scheduled'; return; } el.innerHTML=''; list.slice(0,5).forEach(r=>{ const div=document.createElement('div'); div.className='tiny'; div.innerHTML=`‚Ä¢ <strong>${r.title}</strong> ‚Äî ${r.display}`; el.appendChild(div); }); }

/* ---------------------------
   Export ICS for schedule
   --------------------------- */
document.getElementById('exportICS').onclick = ()=>{ if(!currentUser) return alert('Login'); const sched=load(userKey(currentUser.username,'schedule'),[]); if(!sched.length) return alert('No sessions to export'); let ics='BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Tritunggal//StudyPlanner//EN\n'; sched.forEach((s,i)=>{ const uid=`${currentUser.username}-sched-${i}@tritunggal`; const dtstart=new Date(s.start).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z'; const dtend=new Date(s.end).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z'; ics += `BEGIN:VEVENT\nUID:${uid}\nDTSTAMP:${dtstart}\nDTSTART:${dtstart}\nDTEND:${dtend}\nSUMMARY:${s.title}\nDESCRIPTION:Subject:${s.subject}\nEND:VEVENT\n`; }); ics += 'END:VCALENDAR'; const blob=new Blob([ics],{type:'text/calendar'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`tritunggal_schedule_${currentUser.username}.ics`; a.click(); };

/* ---------------------------
   Quick add +1h session
   --------------------------- */
document.getElementById('addQuickNow').onclick = ()=>{ if(!currentUser) return alert('Login'); const now=new Date(); const end=new Date(now.getTime()+60*60*1000); const obj={title:'Quick Study',subject:'General',color:'#83d7af',start: now.toISOString().slice(0,16), end: end.toISOString().slice(0,16), reminderMins:10}; const key=userKey(currentUser.username,'schedule'); const arr=load(key,[]); arr.push(obj); save(key,arr); addSchedulesToSchedCalendar(); addSchedulesToMainCalendar(); updateProgress(); scheduleAllReminders(); renderRemindersCard(); alert('Quick session added'); };

/* ---------------------------
   Add assigns to calendar (internal)
   --------------------------- */
function addAssignsToCalendar_internal(){ if(!mainCal) return; mainCal.getEvents().forEach(ev=>{ if(ev.id && ev.id.startsWith('assign_')) ev.remove(); }); const arr=load(userKey(currentUser.username,'assign'),[]); arr.forEach((a,i)=>{ const color=subjectColor(a.subject,a.status); mainCal.addEvent({ id:`assign_${i}`, title:a.title, start:a.due, allDay:true, backgroundColor:color, borderColor:color, extendedProps:{type:'assignment', subject:a.subject, priority:a.priority, status:a.status, raw:a}}); }); }
function addAssignsToCalendar(){ addAssignsToCalendar_internal(); }

/* ---------------------------
   scheduleAllInit
   --------------------------- */
function scheduleAllInit(){ addAssignsToCalendar(); addSchedulesToMainCalendar(); addSchedulesToSchedCalendar(); addTodosToCalendar(); updateProgress(); renderAssignList(); renderTodos(); renderResources(); renderCustomQuotes(); renderNextUp(); renderTodaySummary(); scheduleAllReminders(); renderRemindersCard(); }

/* ---------------------------
   Persist/Load startup
   --------------------------- */
document.getElementById('gotoSchedule').onclick = ()=>showScreen('schedule');
document.getElementById('gotoAssignments').onclick = ()=>showScreen('assignments');
document.getElementById('gotoTodo').onclick = ()=>showScreen('todo');
document.getElementById('openCalendar').onclick = ()=>{ showScreen('calendar'); if(mainCal) mainCal.changeView('dayGridMonth'); };
document.getElementById('openCalendarQuick').onclick = ()=>{ showScreen('calendar'); if(mainCal) mainCal.changeView('dayGridMonth'); };
document.getElementById('openProgress').onclick = ()=>{ showScreen('progress'); updateProgress(); };
document.getElementById('logout').onclick = ()=>{ currentUser=null; showScreen('login'); };

/* ensure calendars ready when switching */
function initFullCalendarScheduleIfNeeded(){ if(!schedCal) initFullCalendarSchedule(); }
function initFullCalendarMainIfNeeded(){ if(!mainCal) initFullCalendarMain(); }

document.getElementById('viewWeek').onclick = ()=>{ if(mainCal) mainCal.changeView('timeGridWeek'); };
document.getElementById('viewMonth').onclick = ()=>{ if(mainCal) mainCal.changeView('dayGridMonth'); };

/* afterLogin override to init calendars */
const originalAfterLogin = afterLogin;
afterLogin = function(){ originalAfterLogin(); initFullCalendarMain(); initFullCalendarSchedule(); scheduleAllInit(); };

/* ---------------------------
   Cloud links (simple share-link store)
   --------------------------- */
document.getElementById('saveCloudLink').onclick = ()=>{ if(!currentUser) return alert('Login'); const link=document.getElementById('cloudLink').value.trim(); if(!link) return alert('Paste a share link'); const key=userKey(currentUser.username,'cloudLinks'); const arr=load(key,[]); arr.push(link); save(key,arr); document.getElementById('cloudLink').value=''; renderCloudLinks(); alert('Link saved (use when adding resources)'); };
function renderCloudLinks(){ if(!currentUser) return; const arr=load(userKey(currentUser.username,'cloudLinks'),[]); const el=document.getElementById('cloudLinksList'); if(!arr.length){ el.textContent='No cloud links saved'; return; } el.innerHTML=''; arr.forEach((l,i)=>{ const d=document.createElement('div'); d.className='tiny'; d.innerHTML = `<a href="${l}" target="_blank">${l}</a> <button onclick="removeCloudLink(${i})" style="background:#f2dede;border:none;padding:4px;border-radius:6px;color:#a00;margin-left:6px">Remove</button>`; el.appendChild(d); }); }
function removeCloudLink(i){ const key=userKey(currentUser.username,'cloudLinks'); const arr=load(key,[]); if(arr[i]) arr.splice(i,1); save(key,arr); renderCloudLinks(); }

/* paste share button on resources */
document.getElementById('pasteShare').onclick = ()=>{ navigator.clipboard.readText().then(t=>{ document.getElementById('resLink').value = t; }).catch(()=> alert('Clipboard read failed ‚Äî paste manually')); };

/* ---------------------------
   Profile save
   --------------------------- */
document.getElementById('profileBtn').onclick = ()=>{ if(!currentUser) return alert('Login'); document.getElementById('profileName').value = currentUser.name; showScreen('profile'); };
document.getElementById('saveProfile').onclick = ()=>{ if(!currentUser) return; const name=document.getElementById('profileName').value.trim(); const pass=document.getElementById('profilePass').value; if(name) currentUser.name=name; if(pass) currentUser.pass=pass; // update user list
  const users=load(LS.users,[]); const idx=users.findIndex(u=>u.username===currentUser.username); if(idx>=0){ users[idx]=currentUser; save(LS.users,users); } document.getElementById('greeting').textContent = `Welcome, ${currentUser.name}`; alert('Profile saved'); showScreen('dashboard'); };

/* ---------------------------
   Clear local data for current user
   --------------------------- */
document.getElementById('clearLocal').onclick = ()=>{ if(!currentUser) return alert('Login'); if(!confirm('Clear local data for this user? This cannot be undone.')) return; ['assign','schedule','todos','res','quotes','motivationOn','cloudLinks','notifSettings'].forEach(k=>localStorage.removeItem(userKey(currentUser.username,k))); alert('Local data cleared'); afterLogin(); };

/* ---------------------------
   Misc: render cloud links and custom quotes on load
   --------------------------- */
function renderCloudLinks(){ if(!currentUser) return; const arr=load(userKey(currentUser.username,'cloudLinks'),[]); const el=document.getElementById('cloudLinksList'); if(!arr.length){ el.textContent='No cloud links saved'; return; } el.innerHTML=''; arr.forEach((l,i)=>{ const d=document.createElement('div'); d.className='tiny'; d.innerHTML = `<a href="${l}" target="_blank">${l}</a> <button onclick="removeCloudLink(${i})" style="background:#f2dede;border:none;padding:4px;border-radius:6px;color:#a00;margin-left:6px">Remove</button>`; el.appendChild(d); }); }

/* ---------------------------
   On initial load: attempt to auto-login demo if present
   --------------------------- */
(function tryAutoLogin(){ const users=load(LS.users,[]); if(users.length===1 && users[0].username==='demo' && users[0].pass==='demo'){ currentUser=users[0]; afterLogin(); } })();

</script>
</body>
</html>
